name: Build Docker Image and Update Manifest

on:
  push:
    branches: [ "main" ]

env:
  # --- IMPORTANT: REPLACE THESE VALUES ---
  DOCKER_IMAGE_NAME: goku431/3-tier-todo-app
  MANIFEST_REPO: goku31s/to-do-list-ingress-CD
  # --- END OF VALUES TO REPLACE ---

jobs:
  # Job 1: Build the Docker image and push it to Docker Hub
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and Push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: |
          ${{ env.DOCKER_IMAGE_NAME }}:latest
          ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

  # Job 2: Update the manifest file in the CD repository
  update-manifest-repo:
    name: Update Manifest Repository
    runs-on: ubuntu-latest
    needs: build-and-push # This job runs only after the image is pushed

    steps:
    - name: Checkout CD (manifest) repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.MANIFEST_REPO }}
        token: ${{ secrets.PAT_TOKEN }}
        path: manifest-repo # Check out to a specific directory

    - name: Update image tag using yq
      working-directory: manifest-repo
      run: |
        # Install yq
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq

        # The yq command finds the container named 'webapp' and updates its image tag
        yq -i '(.spec.template.spec.containers[] | select(.name=="webapp") | .image) = "${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}"' kubernetes-manifests/webapp.yaml

    - name: Commit and push changes to CD repo
      working-directory: manifest-repo
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add .
        git commit -m "Update image for 3-tier-app to ${{ github.sha }}" || echo "No changes to commit"
        git push
